OBJDIR    = obj/
BINDIR    = ../../bin/
SOURCEDIR = 

OUTFILE = $(BINDIR)ntoskrnl.exe
MODULES = $(SOURCEDIR)ntoskrnl
OBJS = $(OBJDIR)start.o $(OBJDIR)main.o $(OBJDIR)exceptions.o $(OBJDIR)stdio.o $(OBJDIR)stdlib.o $(OBJDIR)string.o $(OBJDIR)conio.o $(OBJDIR)irq.o $(OBJDIR)intr.o $(OBJDIR)keyb.o $(OBJDIR)keyb_irq.o $(OBJDIR)timer_asm.o $(OBJDIR)timer.o $(OBJDIR)time.o $(OBJDIR)memory.o $(OBJDIR)floppy.o $(OBJDIR)floppy_irq.o $(OBJDIR)device.o $(OBJDIR)vfs.o $(OBJDIR)fat.o

CC   = gcc
ASM  = ../../scripts/nasm
#ASM  = nasm
LINK = ld.exe
RM = rm -f -r

CFLAGS   = -fomit-frame-pointer -fno-builtin -O3
ASMFLAGS = -f win32
LFLAGS   = -T link.ld -Map ntoskrnl.map -nostdlib -shared --image-base 0x400000

.PHONY: clean

$(OUTFILE): $(OBJS)
	$(LINK) $(LFLAGS) -o $@ $(OBJS)

$(OBJDIR)%.o: $(SOURCEDIR)%.s
	$(ASM) $(ASMFLAGS) $< -o $@

$(OBJDIR)%.o: $(SOURCEDIR)%.S
	$(ASM) $(ASMFLAGS) $< -o $@

$(OBJDIR)%.o: $(SOURCEDIR)%.c
	$(CC) $(CFLAGS) -c $< -o $@

clean:
	$(RM) "$(BINDIR)"
	mkdir "$(BINDIR)"
	$(RM) "$(OBJDIR)"
	mkdir "$(OBJDIR)"

#REM -nostdlib -fno-leading-underscore 